<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Evolution Simulation</title>
  <style>
    body { margin: 0; background: #000; overflow: hidden; }
    canvas { display: block; margin: 0 auto; background: #111; }
  </style>
</head>
<body>
  <canvas id="world" width="800" height="800"></canvas>
  <script>
    const ws = new WebSocket(`ws://${location.host}/ws`);
    const canvas = document.getElementById("world");
    const ctx = canvas.getContext("2d");
    let scale = 0;

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      renderWorld(data);
    };

    function renderWorld(data) {
      const { grid, cells, tick } = data;
      if (!grid) return;

      const { width, height, substances } = grid;
      scale = Math.min(canvas.width / width, canvas.height / height);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (substances) {
        substances.forEach(s => {
          switch (s.type) {
            case "TOXIN": ctx.fillStyle = "#ff0040"; break;
            case "ORGANIC": ctx.fillStyle = "#00ff40"; break;
            case "INORGANIC": ctx.fillStyle = "#00ffff"; break;
            default: ctx.fillStyle = "#888";
          }
          ctx.globalAlpha = Math.min(1, s.concentration * 0.8 + 0.2);
          ctx.fillRect(s.x * scale, s.y * scale, scale, scale);
        });
      }

      if (cells) {
        ctx.globalAlpha = 1.0;
        ctx.fillStyle = "#00aaff";
        cells.forEach(c => {
          const [x, y] = c.position;
          ctx.beginPath();
          ctx.arc(x * scale, y * scale, scale * 0.3, 0, Math.PI * 2);
          ctx.fill();
        });
      }

      ctx.fillStyle = "#fff";
      ctx.font = "16px monospace";
      ctx.fillText(`tick: ${tick}`, 10, 20);
    }
  </script>
</body>
</html>
