<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Evolution Simulation</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #0c0c0c;
      color: #ddd;
      font-family: "Consolas", monospace;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
    #sidebar {
      width: 260px;
      background: #111;
      border-right: 2px solid #222;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    #sidebar h2 {
      font-size: 20px;
      color: #5df53b;
      margin-bottom: 10px;
    }

    .checkbox-group label {
      display: block;
      margin: 6px 0;
      cursor: pointer;
    }

    .stats {
      font-size: 14px;
      color: #aaa;
      line-height: 1.5;
      background: #181818;
      padding: 10px;
      border-radius: 6px;
    }

    /* –ü–æ–ª–µ —Å–∏–º—É–ª—è—Ü–∏–∏ */
    #canvas-container {
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #080808;
    }

    canvas {
      background: #111;
      border: 2px solid #444;
      box-shadow: 0 0 15px rgba(0, 255, 100, 0.15);
      border-radius: 8px;
    }

    footer {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
  <div id="sidebar">
    <div>
      <h2>üß¨ Evolution</h2>
      <div class="checkbox-group">
        <label><input type="checkbox" id="toggle-organic" checked> –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∫—É</label>
        <label><input type="checkbox" id="toggle-inorganic" checked> –ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–æ—Ä–≥–∞–Ω–∏–∫—É</label>
        <label><input type="checkbox" id="toggle-toxin" checked> –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–∫—Å–∏–Ω—ã</label>
      </div>

      <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
      <div class="stats" id="stats">
        tick: 0<br>
        –∫–ª–µ—Ç–∫–∏: 0<br>
        –≤–µ—â–µ—Å—Ç–≤–∞: 0<br>
        —Ä–∞–∑–º–µ—Ä: 0√ó0
      </div>
    </div>

    <footer>¬© 2025 Evolution Simulator</footer>
  </div>

  <!-- –ü–æ–ª–µ -->
  <div id="canvas-container">
    <canvas id="world" width="900" height="900"></canvas>
  </div>

  <script>
    const ws = new WebSocket(`ws://${location.host}/ws`);
    const canvas = document.getElementById("world");
    const ctx = canvas.getContext("2d");
    const statsBox = document.getElementById("stats");

    // —á–µ–∫–±–æ–∫—Å—ã
    const showOrganic = document.getElementById("toggle-organic");
    const showInorganic = document.getElementById("toggle-inorganic");
    const showToxin = document.getElementById("toggle-toxin");

    let scale = 0;

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      renderWorld(data);
      updateStats(data);
    };

    function updateStats(data) {
      const env = data.environment;
      if (!env || !env.grid) return;

      const cellsCount = env.cells ? env.cells.length : 0;
      const subsCount = env.grid?.substances?.length || 0;
      const { width, height } = env.grid;

      statsBox.innerHTML = `
        tick: ${data.tick}<br>
        –∫–ª–µ—Ç–∫–∏: ${cellsCount}<br>
        –≤–µ—â–µ—Å—Ç–≤–∞: ${subsCount}<br>
        —Ä–∞–∑–º–µ—Ä: ${width}√ó${height}
      `;
    }

    function renderWorld(data) {
      const env = data.environment;
      if (!env || !env.grid) return;

      const { grid, cells } = env;
      const { width, height, substances } = grid;
      scale = Math.min(canvas.width / width, canvas.height / height);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // === –í–ï–©–ï–°–¢–í–ê ===
      if (substances) {
        substances.forEach(s => {
          if (s.type === "TOXIN" && !showToxin.checked) return;
          if (s.type === "ORGANIC" && !showOrganic.checked) return;
          if (s.type === "INORGANIC" && !showInorganic.checked) return;

          switch (s.type) {
            case "TOXIN": ctx.fillStyle = "#F55B3B"; break;
            case "ORGANIC": ctx.fillStyle = "#5DF53B"; break;
            case "INORGANIC": ctx.fillStyle = "#3BCAF5"; break;
            default: ctx.fillStyle = "#888888";
          }

          // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –≤ –¥–∏–∞–ø–∞–∑–æ–Ω 0..1
           const maxC = 10.0;  // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è
           const minC = 0.1;   // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è (–∏–ª–∏ 0)
           const norm = Math.min(1, Math.max(0, (s.concentration - minC) / (maxC - minC)));

           // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏
           ctx.globalAlpha = 0.1 + 0.9 * norm;  // –æ—Ç 0.1 –¥–æ 1.0
          ctx.fillRect(s.x * scale, s.y * scale, scale, scale);
        });
      }

      // === –ö–õ–ï–¢–ö–ò ===
      if (cells) {
        ctx.globalAlpha = 1.0;
        ctx.fillStyle = "#ffffff";
        cells.forEach(c => {
          const [x, y] = c.position;
          ctx.beginPath();
          ctx.arc(x * scale, y * scale, scale * 0.3, 0, Math.PI * 2);
          ctx.fill();
        });
      }

      // === –ì—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª—è ===
      ctx.strokeStyle = "#555";
      ctx.lineWidth = 2;
      ctx.strokeRect(0, 0, width * scale, height * scale);
    }
  </script>
</body>
</html>
