<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Evolution Simulation</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #0c0c0c;
      color: #ddd;
      font-family: "Consolas", monospace;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
    #sidebar {
      width: 400px;
      background: #111;
      border-right: 2px solid #222;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    #sidebar h2 {
      font-size: 20px;
      color: #5df53b;
      margin-bottom: 10px;
    }

    .checkbox-group label {
      display: block;
      margin: 6px 0;
      cursor: pointer;
    }

    .stats {
      font-size: 14px;
      color: #aaa;
      line-height: 1.5;
      background: #181818;
      padding: 10px;
      border-radius: 6px;
    }

    /* –ü–æ–ª–µ —Å–∏–º—É–ª—è—Ü–∏–∏ */
    #canvas-container {
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #080808;
    }

    canvas {
      background: #111;
      border: 2px solid #444;
      box-shadow: 0 0 15px rgba(0, 255, 100, 0.15);
      border-radius: 8px;
    }

    footer {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
  <div id="sidebar">
    <div>
      <h2>üïπÔ∏è Controls</h2>
      <div class="checkbox-group">
        <label><input type="checkbox" id="toggle-organic" checked> Display organic</label>
        <label><input type="checkbox" id="toggle-inorganic" checked> Display inorganic</label>
        <label><input type="checkbox" id="toggle-toxin" checked> Display toxins</label>
      </div>

      <h2>üìä World Stats</h2>
      <div class="stats" id="stats"></div>
    </div>

    <footer>¬© 2025 Evolution Simulator</footer>
  </div>

  <!-- –ü–æ–ª–µ -->
  <div id="canvas-container">
    <canvas id="world" width="900" height="900"></canvas>
  </div>

  <script>
    const ws = new WebSocket(`ws://${location.host}/ws`);
    const canvas = document.getElementById("world");
    const ctx = canvas.getContext("2d");
    const statsBox = document.getElementById("stats");

    // —á–µ–∫–±–æ–∫—Å—ã
    const showOrganic = document.getElementById("toggle-organic");
    const showInorganic = document.getElementById("toggle-inorganic");
    const showToxin = document.getElementById("toggle-toxin");

    let scale = 0;

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      renderWorld(data);
      updateStats(data);
    };

    function updateStats(data) {
      const env = data.environment;
      const stats = env.env_stats;
      if (!env || !env.grid) return;

      const cellsCount = env.cells ? env.cells.length : 0;
      const subsCount = env.grid?.substances?.length || 0;
      const { width, height } = env.grid;
      const tickTime = data.tick_time_ms ? data.tick_time_ms.toFixed(3) : 0;
      const tickPerSec = tickTime ? (1000/tickTime).toFixed(1) : 0;

      statsBox.innerHTML = `
          <div style="margin-left:5px;">
            <b>Tick:</b> ${data.tick}<br>
            <b>TPS:</b> ${tickPerSec}<br>
            <b>Tick time:</b> ${tickTime} ms<br>
            <b>World size:</b> ${width}√ó${height}<br>
          </div>

          <hr style="border-color:#333; margin:6px 0;">

          <div style="color:#3bf5c4; font-weight:bold; font-size:15px; margin-bottom:4px;">üß´ CELLS</div>
          <div style="margin-left:5px;">
            <b>Total cells:</b> ${stats.cells_total}<br>
            <b>Cell limit:</b> ${stats.cells_limit}<br>
            <b>Avg. energy:</b> ${stats.avg_energy.toFixed(2)}<br>
            <b>Avg. health:</b> ${stats.avg_health.toFixed(2)}<br>
            <b>Avg. age:</b> ${stats.avg_age.toFixed(2)}<br>
            <b>Avg. genes:</b> ${stats.avg_genes.toFixed(2)}<br>
            <b>Avg. active genes:</b> ${stats.avg_active_genes.toFixed(2)}<br>
          </div>

          <hr style="border-color:#333; margin:6px 0;">

          <div style="color:#f5a33b; font-weight:bold; font-size:15px; margin-bottom:4px;">üß™ SUBSTANCES</div>
          <div style="margin-left:5px;">
            <b>Unique substances:</b> ${stats.total_unique_substances}<br><br>

            <span style="color:#5DF53B; font-weight:bold;">Organic:</span><br>
            &nbsp;‚Ä¢ Count: ${stats.substances_by_type.ORGANIC}<br>
            &nbsp;‚Ä¢ Total concentration: ${stats.substances_concentration_by_type.ORGANIC}<br><br>

            <span style="color:#3BCAF5; font-weight:bold;">Inorganic:</span><br>
            &nbsp;‚Ä¢ Count: ${stats.substances_by_type.INORGANIC}<br>
            &nbsp;‚Ä¢ Total concentration: ${stats.substances_concentration_by_type.INORGANIC}<br><br>

            <span style="color:#F55B3B; font-weight:bold;">Toxins:</span><br>
            &nbsp;‚Ä¢ Count: ${stats.substances_by_type.TOXIN}<br>
            &nbsp;‚Ä¢ Total concentration: ${stats.substances_concentration_by_type.TOXIN}<br>
          </div>

          <hr style="border-color:#333; margin:6px 0;">
        `;
    }

    function renderWorld(data) {
      const env = data.environment;
      if (!env || !env.grid) return;

      const { grid, cells } = env;
      const { width, height, substances } = grid;
      scale = Math.min(canvas.width / width, canvas.height / height);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // === –í–ï–©–ï–°–¢–í–ê ===
      if (substances) {
        substances.forEach(s => {
          if (s.type === "TOXIN" && !showToxin.checked) return;
          if (s.type === "ORGANIC" && !showOrganic.checked) return;
          if (s.type === "INORGANIC" && !showInorganic.checked) return;

          switch (s.type) {
            case "TOXIN": ctx.fillStyle = "#F55B3B"; break;
            case "ORGANIC": ctx.fillStyle = "#5DF53B"; break;
            case "INORGANIC": ctx.fillStyle = "#3BCAF5"; break;
            default: ctx.fillStyle = "#888888";
          }

          // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –≤ –¥–∏–∞–ø–∞–∑–æ–Ω 0..1
           const maxC = 20.0;  // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è
           const minC = 0.1;   // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è (–∏–ª–∏ 0)
           const norm = Math.min(1, Math.max(0, (s.concentration - minC) / (maxC - minC)));

           // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏
           ctx.globalAlpha = 0.1 + 0.9 * norm;  // –æ—Ç 0.1 –¥–æ 1.0
          ctx.fillRect(s.x * scale, s.y * scale, scale, scale);
        });
      }

      // === –ö–õ–ï–¢–ö–ò ===
      if (cells) {
        ctx.globalAlpha = 1.0;
        const cellRadius = data.cell_radius || 0.5;
        cells.forEach(c => {
          const [x, y] = c.position;
          const fill = (typeof c.color_hex === "string" && c.color_hex.startsWith("#")) ? c.color_hex : "#BBBBBB";
          ctx.beginPath();
          ctx.arc(x * scale, y * scale, cellRadius * scale, 0, Math.PI * 2);
          ctx.fillStyle = fill;
          ctx.fill();
        });
      }

      // === –ì—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª—è ===
      ctx.strokeStyle = "#555";
      ctx.lineWidth = 2;
      ctx.strokeRect(0, 0, width * scale, height * scale);
    }
  </script>
</body>
</html>
